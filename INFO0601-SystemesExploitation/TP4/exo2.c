
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>
#include <signal.h>

#define Stou_0 "\033[0m"	// RESET
#define Stou_R "\033[0;31m" // RED
#define Stou_Y "\033[0;33m"	// YELLOW

#ifndef SIGKILL
#define SIGKILL 0
#endif

int main(int argc, char *argv[]) {
	printf("\n");

	if (argc != 2) {
		printf("Usage: %s <nombre_de_fils>\n", argv[0]);
		return EXIT_FAILURE;
	}

	int n = atoi(argv[1]);
	// Création de n tubes
	int** _pipes = malloc(n * sizeof(int*));
	if (_pipes == NULL) {
		perror("Erreur lors du malloc #1");
		exit(EXIT_FAILURE);
	}
	int i;
	for (i = 0; i < n; i++) {
		_pipes[i] = malloc(2 * sizeof(int));
		if (pipe(_pipes[i]) == -1) {
			perror("Erreur lors de la création d'un tube");
			exit(EXIT_FAILURE);
		}
	}

	// Création des fils
	int* pids = malloc(n * sizeof(int));
	for (i = 0; i < n; i++) {
		if ((pids[i] = fork()) == 0) {

			while (1) {
				char r[64], w[96];
				if (read(_pipes[i][0], r, sizeof(r)) == -1) {
					perror("Erreur lors de la lecture dans le tube");
					exit(EXIT_FAILURE);
				}

				printf(Stou_Y"[Fils #%d] J'ai lu %s !\n"Stou_0, i, r);
				sprintf(w, "%d bien reçu", i);

				if (write(_pipes[i][1], w, sizeof(w)) == -1) {
					perror("Erreur lors de l'écriture dans le tube");
					exit(EXIT_FAILURE);
				}
			}

			exit(EXIT_SUCCESS);
		}
	}

	i = 0;
	char buffer[64], buffer_r[96];
	while (1) {

		printf("Entrez le numéro d'un fils entre 1 et %d (-1 pour arrêter) : ", n);
		scanf("%d", &i);
		if (i < 0 || i > n)
			break;
		printf("\nEntrez une chaine de caractères : ");
		scanf("%63s", buffer);

		if (write(_pipes[i][1], buffer, sizeof(buffer)) == -1) {
			perror("Erreur lors de l'écriture dans le tube");
			exit(EXIT_FAILURE);
		}

		if (read(_pipes[i][0], buffer_r, sizeof(buffer_r)) == -1) {
			perror("Erreur lors de la lecture dans le tube");
			exit(EXIT_FAILURE);
		}
		printf(Stou_R"\nReçu du fils : %s\n"Stou_0, buffer_r);
	}

	// Envoie d'un code d'arrêt aux fils
	for (i = 0; i < n; i++)
		if (kill(pids[i], SIGKILL) == -1) {
			perror("Erreur lors du signal d'arrêt");
			exit(EXIT_FAILURE);
		}
	
	for (i = 0; i < n; i++) {
		close(_pipes[i][0]);
		close(_pipes[i][1]);
	}

	for (i = 0; i < n; i++) {
		pid_t pid = wait(NULL);
		printf(Stou_R"Mon fils %d a terminé !\n"Stou_0, pid);
	}
	
	return EXIT_SUCCESS;
}

