
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <time.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <sys/sem.h>
#include <sys/stat.h>
#include <errno.h>

#include "include_kill.h"

int semid;

void P(int S, int operation) {
	struct sembuf op;
	op.sem_num = S;
	op.sem_op = -operation;
	op.sem_flg = 0;
	if (semop(semid, &op, 1) == -1) {
		perror("Error on semaphore operation");
		exit(EXIT_FAILURE);
	}
}

void V(int S, int operation) {
	struct sembuf op;
	op.sem_num = S;
	op.sem_op = operation;
	op.sem_flg = 0;
	if (semop(semid, &op, 1) == -1) {
		perror("Error on semaphore operation");
		exit(EXIT_FAILURE);
	}
}

void child() {
	int client_id;

	// Connect and get client id :
	// P(S2, 1) && P(S1, 1) - getval - V(S2, 1)
	struct sembuf op[2];
	op[0].sem_num = S2;
	op[0].sem_op = -1;
	op[0].sem_flg = 0;
	op[1].sem_num = S1;
	op[1].sem_op = -1;
	op[1].sem_flg = 0;
	if (semop(semid, &op, 2) == -1 || (client_id = semctl(semid, S1, GETVAL)) == -1) {
        perror("Error getting the semaphore client value");
        exit(EXIT_FAILURE);
    }
	V(S2, 1);

	///////////////////////////////
	/// TODO
	///////////////////////////////
	srand(getpid());
	int run = 1;
	while (run) {
		usleep(rand() % 100000 + 50000);

		// Kill a client TODO

		// Check if I got killed TODO
	}

	// Disconnect
	P(S2, 1);
	V(S1, 1)
	V(S2, 1);
	V(S3, 1);
	exit(EXIT_SUCCESS);
}

/**
 * Main function.
 * @param argc the number of arguments
 * @param argv arguments
 * @return the return code
 */
int main(int argc, char *argv[]) {
	printf("\n");

	// Create the semaphore set
	if((semid = semget(key, 0, 0)) == -1) {
        perror("Error getting semaphore set identifier");
        exit(EXIT_FAILURE);
    }

	// Create MAX_CLIENTS clients
	int i;
	for (i = 0; i < MAX_CLIENTS; i++)
		if (fork() == 0)
			child();

	return EXIT_SUCCESS;
}

