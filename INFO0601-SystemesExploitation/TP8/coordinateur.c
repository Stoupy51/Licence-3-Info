
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <time.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <sys/sem.h>
#include <sys/stat.h>
#include <errno.h>

#include "include_kill.h"

/**
 * Main function.
 * @param argc the number of arguments
 * @param argv arguments
 * @return the return code
 */
int main(int argc, char *argv[]) {
	printf("\n");
	int semid;
	unsigned short semvals[] = {MAX_CLIENTS, 1, 0, 0, 0, 0, 0};
	int nbSemaphores = sizeof(semvals) / sizeof(unsigned short);

	// Create the semaphore set
	if ((semid = semget(KEY, nbSemaphores, S_IRUSR | S_IWUSR | IPC_CREAT | IPC_EXCL)) == -1) {
		if (errno == EEXIST)
			fprintf(stderr, "Set (key=%d) already exists\n", KEY);
		else
			perror("Error creating set");
		exit(EXIT_FAILURE);
	}

	// Initialize the set
	if (semctl(semid, 0, SETALL, val) == -1) {
		perror("Error initializing values");
		exit(EXIT_FAILURE);
	}

	// Semaphore operation structure
	struct sembuf op;
	op.sem_num = S1;
	op.sem_op = -1;
	op.sem_flg = 0;

	// Wait for every clients to be dead
	int remaining = 1;
	while (remaining != 0) {
		// Wait for a client to die
		if (semop(semid, &op, 1) == -1) {
			perror("Error on semaphore operation");
			exit(EXIT_FAILURE);
		}

		// Get remaining clients
		if ((remaining = semctl(semid, S1, GETVAL)) == -1) {
			perror("Error getting the semaphore remaining clients");
			exit(EXIT_FAILURE);
		}
	}
	
	// Delete the semaphore set
	if (semctl(semid, IPC_RMID, 0) == -1) {
		perror("Error deleting semaphore set");
		exit(EXIT_FAILURE);
	}
	printf("Semaphore set deleted.\n");

	return EXIT_SUCCESS;
}

