
/**
 * Ce programme est un Ã©diteur de niveau pour le projet de INFO0601
 * @author Alexandre COLLIGNON
 **/
#include <stdlib.h>
#include <locale.h>
#include <unistd.h>

#include "functions.h"
#include "window.h"
#include "image.h"
#include "interface.h"
#include "colors.h"

int main(int argc, char *argv[]) {
	int ch;
	interface_t *interface;
	image_t *image;
	bool quit = false;

	// Check arguments and load or create the file
	if (
		(argc == 2) &&
		(access(argv[1], F_OK) == 0) &&
		((image = image_load(argv[1])) == NULL)
	) {
		fprintf(stderr, "File '%s' doesn't exist, creating it...\n", argv[1]);
		image = image_create(L_WIDTH, L_HEIGHT);
	}
	else {
		// Bad arguments
		fprintf(stderr, "Load a file:\n\t%s file\n\t\tfile: file to load\n", argv[0]);
		exit(EXIT_FAILURE);
	}

	// ncurses initialisation
	setlocale(LC_ALL, "");
	ncurses_init();
	ncurses_init_mouse();
	ncurses_colors(); 
	palette();
	clear();
	refresh();	

	// Create interface
	interface = interface_create(image);

	// Main loop
	while(quit == false) {
		ch = getch();
		if((ch == 'Q') || (ch == 'q'))
			quit = true;
		else
			interface_actions(interface, ch);
	}
	
	// Stop ncurses
	ncurses_stop();
	
	// Sauvegarde de l'image
	image_save(argv[1], image);

	// Suppression de l'interface
	interface_delete(&interface);

	return EXIT_SUCCESS;
}
