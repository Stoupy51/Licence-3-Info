
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>

typedef struct personne_t {
	int age;
	char* nom;
	char* prenom;
} personne_t;

int main(int argc, char *argv[]) {
	if (argc != 2) {
		fprintf(stderr, "Usage: %s <file>\n", argv[0]);
		exit(EXIT_FAILURE);
	}

	int fd;
	if ((fd = open(argv[1], O_WRONLY | O_CREAT, S_IRUSR | S_IWUSR)) == -1) {
		perror("\nErreur lors de l'ouverture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	personne_t p = {20, "Hey", "My friend"};
	size_t t_nom = strlen(p.nom);
	size_t t_prenom = strlen(p.prenom);
	if (
		write(fd, &p.age, sizeof(p.age)) == -1 ||
		write(fd, &t_nom, sizeof(t_nom)) == -1 || write(fd, p.nom, t_nom) == -1 ||
		write(fd, &t_prenom, sizeof(t_prenom)) == -1 || write(fd, p.prenom, t_prenom) == -1
	) {
		perror("Erreur lors de l'écriture dans le fichier !\n");
		exit(EXIT_FAILURE);
	}

	if (close(fd) == -1) {
		perror("Erreur lors de la fermeture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	// Partie lecture

	if ((fd = open(argv[1], O_RDONLY | O_CREAT, S_IRUSR | S_IWUSR)) == -1) {
		perror("\nErreur lors de l'ouverture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	personne_t p2;
	if (
		read(fd, &p2.age, sizeof(p2.age)) == -1 ||
		read(fd, &t_nom, sizeof(t_nom)) == -1 || (p2.nom = malloc(t_nom)) == NULL || read(fd, p2.nom, t_nom) == -1 ||
		read(fd, &t_prenom, sizeof(t_prenom)) == -1 || (p2.prenom = malloc(t_prenom)) == NULL || read(fd, p2.prenom, t_prenom) == -1
	) {
		perror("Erreur lors de la lecture dans le fichier !\n");
		exit(EXIT_FAILURE);
	}
	printf("\nAge : %d, Nom : %s, Prénom : %s", p2.age, p2.nom, p2.prenom);

	if (close(fd) == -1) {
		perror("Erreur lors de la fermeture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	printf("\n");
	return EXIT_SUCCESS;
}

