
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>

typedef struct personne_t {
	int age;
	char* nom;
	char* prenom;
} personne_t;

int main(int argc, char *argv[]) {
	if (argc != 2) {
		fprintf(stderr, "Usage: %s <file>\n", argv[0]);
		exit(EXIT_FAILURE);
	}

	int fd;
	if ((fd = open(argv[1], O_WRONLY | O_CREAT, S_IRUSR | S_IWUSR)) == -1) {
		perror("\nErreur lors de l'ouverture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	personne_t p = {20, "Hey", "My friend"};
	size_t t = sizeof(p.age) + strlen(p.nom) + strlen(p.prenom);
	if (write(fd, &t, sizeof(t)) == -1 || write(fd, &p, sizeof(p)) == -1) {
		perror("Erreur lors de l'écriture dans le fichier !\n");
		exit(EXIT_FAILURE);
	}

	if (close(fd) == -1) {
		perror("Erreur lors de la fermeture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	// Partie lecture

	if ((fd = open(argv[1], O_RDONLY | O_CREAT, S_IRUSR | S_IWUSR)) == -1) {
		perror("\nErreur lors de l'ouverture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	if (read(fd, &t, sizeof(size_t)) == -1 || read(fd, &p, t)) {
		perror("Erreur lors de la lecture dans le fichier !\n");
		exit(EXIT_FAILURE);
	}
	printf("\nAge : %d, Nom : %s, Prénom : %s", p.age, p.nom, p.prenom);

	if (close(fd) == -1) {
		perror("Erreur lors de la fermeture du fichier !\n");
		exit(EXIT_FAILURE);
	}

	printf("\n");
	return EXIT_SUCCESS;
}

