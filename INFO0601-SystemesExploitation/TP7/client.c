
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <ncurses.h>

#include "include.h"

#define xstr(s) str(s)
#define str(s) #s

int main(int argc, char *argv[]) {
    bool stop = FALSE;
	message_t msg;
    char c;
    
    // Get the message queue
	int msqid;
	if ((msqid = msgget(KEY, S_IRUSR | S_IWUSR)) == -1) {
		perror("Error while opening queue\n");
		exit(EXIT_FAILURE);
	}
    
    // Main loop
    printf("Type messages; #QUIT# to quit, #STOP# to stop the viewer\n");
    while (stop == FALSE) {
        printf("Type a message: ");
        if (scanf("%"xstr(MAX_MSG)"[^\n]", msg.msg) != 1) {
            fprintf(stderr, "Nothing to read\n");
            exit(EXIT_FAILURE);
        }
        while (((c = getchar()) != '\n') || (c == EOF));
        
        if (strcmp(msg.msg, "#QUIT#") == 0)
            stop = TRUE;
        else {
            // Send the message
            msg.type = 1;
			msg.client_pid = getpid();
			if (msgsnd(msqid, &msg, sizeof(message_t) - sizeof(long), 0) == -1) {
				perror("Error while sending message\n");
				exit(EXIT_FAILURE);
			}
            printf("Message sent.\n");

			// Receive message
			if (msgrcv(msqid, &msg, sizeof(message_t) - sizeof(long), getpid(), 0) == -1) {
				perror("Error while receiving message\n");
				exit(EXIT_FAILURE);
			}
			printf("Received message: %s\n", msg.msg);
            
            if (strcmp(msg.msg, "#STOP#") == 0)
                stop = TRUE;
        }
    }
    
    return EXIT_SUCCESS;
}

