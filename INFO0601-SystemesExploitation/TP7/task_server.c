
#include <stdio.h>
#include <stdlib.h>
#include <ncurses.h>
#include <locale.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include "functions.h"
#include "window.h"
#include "colors.h"
#include "include.h"

#define Stou_0 "\033[0m"	// RESET
#define Stou_R "\033[0;31m" // RED
#define Stou_G "\033[0;32m" // GREEN
#define Stou_Y "\033[0;33m" // YELLOW

int msqid;

void child(int id) {
	char prefix[16];
	sprintf(prefix, "[Worker #%d]", id);

	int loop = 1;
	while (loop){
		sleep(rand() % 10 + 5);
		if (rand() % 10 == 0)
			loop = 0;
	}
	printf(Stou_R "%s Fermeture du client..." Stou_0);
}

int main(int argc, char *argv[]) {
    bool stop = FALSE;    
    
    // Create/get the message queue
	if ((msqid = msgget(KEY, IPC_CREAT | S_IRUSR | S_IWUSR)) == -1) {
		perror("Error while creating / opening queue\n");
		exit(EXIT_FAILURE);
	}

	// Creation des workers
	int i;
	for (i = 1; i <= 100; i++) {
		if (fork() == 0) {
			child(i);
			exit(EXIT_SUCCESS);
		}
	}
    
    // Main lool
    while (stop == FALSE) {
        // Receive message
        message_t msg;
		if (msgrcv(msqid, &msg, sizeof(message_t) - sizeof(long), 0, 0) == -1) {
			fprintf(stderr, "Error while receiving message\n");
			exit(EXIT_FAILURE);
		}
        
        // Stop or display message
        if (strcmp(msg.msg, "#STOP#") == 0) {            
            stop = TRUE;
            window_printw(win, "Stop request received...\n");
            window_refresh(win);
            sleep(1);
        }
        else {
            window_printw(win, "%s\n", msg.msg);
            window_refresh(win);
        }

		// Return to sender
		msg.type = msg.client_pid;
		strcpy(msg.msg, Stou_G "Message bien reÃ§u !" Stou_0);
		if (msgsnd(msqid, &msg, sizeof(message_t) - sizeof(long), 0) == -1) {
			perror("Error while sending message\n");
			exit(EXIT_FAILURE);
		}
    }
    
    // Stop ncurses
    window_delete(&win);
    ncurses_stop();

    // Delete queue
    if (msgctl(msqid, IPC_RMID, NULL) == -1) {
		fprintf(stderr, "Error while deleting queue\n");
		exit(EXIT_FAILURE);
	}
    printf("Queue deleted.\n");

    return EXIT_SUCCESS;    
}

