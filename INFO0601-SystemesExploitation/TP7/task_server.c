
#include <stdio.h>
#include <stdlib.h>
#include <locale.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include "include.h"

#define Stou_0 "\033[0m"	// RESET
#define Stou_R "\033[0;31m" // RED
#define Stou_G "\033[0;32m" // GREEN
#define Stou_Y "\033[0;33m" // YELLOW

int msqid;

void child(int id) {
	int loop = 1;
	srand(getpid());
	while (loop){
		// Receive a task from the server
		request_t rq;
		if (msgrcv(msqid, &rq, sizeof(rq) - sizeof(long), RQ_TASK, 0) == -1) {
			perror("Error while receiving a task");
			exit(EXIT_FAILURE);
		}
		printf(Stou_Y "[Worker #%d] Received task %d\n" Stou_0, id, rq.value);

		// Sleep for a random time between 0.5 and 0.01 seconds
		usleep((rand() % 10 + 5) * 100000);
		if (rand() % 2 == 0)
			loop = 0;
		
		// Send a message to the server to tell that the task is done
		rq.type = RQ_ANSWER;
		rq.value = rand() % 100;
		if (msgsnd(msqid, &rq, sizeof(rq) - sizeof(long), 0) == -1) {
			perror("Can't send a response message to the server");
			exit(EXIT_FAILURE);
		}
		printf(Stou_Y "[Worker #%d] Task Done %d\n" Stou_0, id, rq.value);
	}
	printf(Stou_R "[Worker #%d] Fermeture du client...\n" Stou_0, id);
}

int main(int argc, char *argv[]) {
	request_t rq;
	memset(&rq, 0, sizeof(rq));
    
    // Create/get the message queue
	if ((msqid = msgget(KEY, IPC_CREAT | S_IRUSR | S_IWUSR)) == -1) {
		perror("Error while creating / opening queue\n");
		exit(EXIT_FAILURE);
	}

	// Create 30 tasks and send them to the message queue
	int i;
	for (i = 0; i < 30; i++) {
		rq.type = RQ_TASK;
		rq.value = i;
		if (msgsnd(msqid, &rq, sizeof(request_t) - sizeof(long), 0) == -1) {
			perror("Can't send a request message to the server");
			exit(EXIT_FAILURE);
		}
	}

	// Creation des workers
	for (i = 1; i <= 10; i++) {
		if (fork() == 0) {
			child(i);
			exit(EXIT_SUCCESS);
		}
	}
    
    // Main loop
	i = 30;
    while (i > 0) {
        // Receiving task done
		if (msgrcv(msqid, &rq, sizeof(rq) - sizeof(long), RQ_ANSWER, 0) == -1) {
			perror("Error while receiving a task");
			exit(EXIT_FAILURE);
		}
		printf(Stou_G "Received task done %d, Progress : %d\n" Stou_0, rq.value, i);
		i--;
    }
	printf(Stou_R "Fermeture du serveur...\n" Stou_0);

    // Delete queue
    if (msgctl(msqid, IPC_RMID, NULL) == -1) {
		fprintf(stderr, "Error while deleting queue\n");
		exit(EXIT_FAILURE);
	}
    printf("Queue deleted.\n");

    return EXIT_SUCCESS;    
}

