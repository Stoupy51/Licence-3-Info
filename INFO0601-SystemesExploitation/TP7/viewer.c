
#include <stdio.h>
#include <stdlib.h>
#include <ncurses.h>
#include <locale.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include "functions.h"
#include "window.h"
#include "colors.h"
#include "include.h"

#define Stou_0 "\033[0m"	// RESET
#define Stou_R "\033[0;31m" // RED
#define Stou_G "\033[0;32m" // GREEN
#define Stou_Y "\033[0;33m" // YELLOW


int main(int argc, char *argv[]) {
    bool stop = FALSE;
    window_t *win;
    
    // ncurses initialization
    setlocale(LC_ALL, "");
    ncurses_init();
    ncurses_init_mouse();
    ncurses_colors(); 
    palette();
    clear();
    refresh();
    
    // Check terminal size
    if ((COLS < WIDTH) || (LINES < HEIGHT)) {
        ncurses_stop();
        fprintf(stderr, 
              "Dimensions are invalid (%d,%d). width must be greater than %d and height mut be greater than %d\n",
              COLS, LINES, WIDTH, HEIGHT);
        exit(EXIT_FAILURE);
    }
    
    // Create window to display messages
    win = window_create(0, 0, COLS, HEIGHT, "Messages", TRUE);
    
    // Create/get the message queue
	int msqid;
	if ((msqid = msgget(KEY, IPC_CREAT | S_IRUSR | S_IWUSR)) == -1) {
		perror("Error while creating / opening queue\n");
		exit(EXIT_FAILURE);
	}
    
    // Main lool
    while (stop == FALSE) {
        // Receive message
        message_t msg;
		if (msgrcv(msqid, &msg, sizeof(message_t) - sizeof(long), 0, 0) == -1) {
			fprintf(stderr, "Error while receiving message\n");
			exit(EXIT_FAILURE);
		}
        
        // Stop or display message
        if (strcmp(msg.msg, "#STOP#") == 0) {            
            stop = TRUE;
            window_printw(win, "Stop request received...\n");
            window_refresh(win);
            sleep(1);
        }
        else {
            window_printw(win, "%s\n", msg.msg);
            window_refresh(win);
        }

		// Return to sender
		msg.type = msg.piddd;
		strcpy(msg.msg, Stou_G "Message bien reÃ§u !" Stou_0);
		if (msgsnd(msqid, &msg, sizeof(message_t) - sizeof(long), 0) == -1) {
			perror("Error while sending message\n");
			exit(EXIT_FAILURE);
		}
    }
    
    // Stop ncurses
    window_delete(&win);
    ncurses_stop();

    // Delete queue
    if (msgctl(msqid, IPC_RMID, NULL) == -1) {
		fprintf(stderr, "Error while deleting queue\n");
		exit(EXIT_FAILURE);
	}
    printf("Queue deleted.\n");

    return EXIT_SUCCESS;    
}

