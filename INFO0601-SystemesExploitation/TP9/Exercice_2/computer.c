
#include <stdio.h>
#include <stdlib.h>
#include <locale.h>
#include <string.h>
#include <unistd.h>
#include <time.h>
#include <sys/shm.h>
#include <sys/sem.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <errno.h>

#include "functions.h"
#include "include.h"

/**
 * Returns a random integer in intervalle [a, b].
 * @param a the lower bound
 * @param b the upper bound
 * @return a random integer
 */
int random_integer(int a, int b) {
    return rand() % (b - a + 1) + a;
}

#define FALSE 0
#define TRUE 1

/**
 * Main function.
 * @param argc the number of arguments
 * @param argv arguments
 * @return the return code
 */
int main(int argc, char *argv[]) {
    int rest, index;
    int x, y;
    unsigned char *player_grid, *computer_grid;
    int *player_rest, *computer_rest;
	char* computer_msg;
	struct sembuf op;
	int stop = 0;
 
    // Initialize the pseudo-random number generator
    srand(time(NULL) + getpid());

	// Create semaphore set
	int semid = semget(KEY + 1, 2, S_IRUSR | S_IWUSR);
	if (semid == -1) {
		perror("Error while creating semaphore set");
		exit(EXIT_FAILURE);
	}

	// Initialize semaphore set
	if (semctl(semid, 0, SETVAL, 1) == -1) {
		perror("Error while initializing semaphore set");
		exit(EXIT_FAILURE);
	}
 
	// Get the shared memory segment
	int shmid = shmget(KEY, 0, 0);
	if (shmid == -1) {
		perror("Error while getting shared memory segment");
		exit(EXIT_FAILURE);
	}
    
    // #TODO# #2 map the segment
    // - player_grid the player's grid
    // - computer_grid the computer's grid
    // - player_rest the number of player remaining boats
    // - computer_rest the number of computer remaining boats
    // - computer_msg the computer's message
	player_grid = shmat(shmid, NULL, 0);
	computer_grid = player_grid + sizeof(unsigned char) * WIDTH * HEIGHT;
	player_rest = (int*)(computer_grid + sizeof(unsigned char) * WIDTH * HEIGHT);
	computer_rest = player_rest + 1;
	computer_msg = (char*)(computer_rest + 1);
	if (player_grid == (void*)-1) {
		perror("Error while attaching shared memory segment");
		exit(EXIT_FAILURE);
	}
    
    // Place computer boats
    if(stop == FALSE) {        
        // Random fill
        rest = BOATS;
        while(rest > 0) {
            y = random_integer(0, HEIGHT - 1);
            x = random_integer(0, WIDTH - 1);
            
            index = y * WIDTH + x;
            if(computer_grid[index] == ' ') {
                computer_grid[index] = 'X';
                rest--;
            }
        }
        
		// V(S1, 1)
		op.sem_num = 0;
		op.sem_op = 1;
		op.sem_flg = 0;
		if (semop(semid, &op, 1) == -1) {
			perror("Error on semaphore operation (1)");
			exit(EXIT_FAILURE);
		}
		printf("Computer boats placed.\n");
    }    
    
    // Main loop
    while((stop == FALSE) && (*player_rest > 0) && (*computer_rest > 0)) {

		// P(S2, 1)
		op.sem_num = 1;
		op.sem_op = -1;
		op.sem_flg = 0;
		if (semop(semid, &op, 1) == -1) {
			perror("Error on semaphore operation (2)");
			exit(EXIT_FAILURE);
		}

		// Play if game is not over
        if((stop == FALSE) && (*player_rest > 0) && (*computer_rest > 0)) {
            
            // #TODO# #9 to delete
            // Random choice of the computer
            do {
                y = random_integer(0, HEIGHT - 1);
                x = random_integer(0, WIDTH - 1);
                index = y * WIDTH + x;
            } while((player_grid[index] != ' ') && (player_grid[index] != 'X'));
			sprintf(computer_msg, "%d %d", x, y);

			// V(S1, 1)
			op.sem_num = 0;
			op.sem_op = 1;
			op.sem_flg = 0;
			if (semop(semid, &op, 1) == -1) {
				perror("Error on semaphore operation (3)");
				exit(EXIT_FAILURE);
			}
			printf("Computer played.\n");
        }
    }

    return EXIT_SUCCESS;    
}

