
#include "include.h"

#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

/**
 * Main function.
 * 
 * @brief Create TCP client that connects to server and receives a grid.
 * 
 * @param argc number of arguments
 * @param argv arguments : server address, server port
 * 
 * @return int EXIT_SUCCESS or EXIT_FAILURE
*/
int main(int argc, char** argv) {
	if (argc != 3) {
		fprintf(stderr,"Usage : %s <server_address> <server_port>\n", argv[0]);
		exit(EXIT_FAILURE);
	}

	// Init variables
	struct sockaddr_in address;
	int server_port = atoi(argv[2]);
	int sockfd;

	// Create TCP socket
    if((sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) == -1) {
        perror(RED"Error creating socket\n"RESET);
        exit(EXIT_FAILURE);
    }

	// Fill server address
	memset(&address, 0, sizeof(struct sockaddr_in));
    address.sin_family = AF_INET;			// IPv4
    address.sin_port = htons(server_port);	// Port
    if(inet_pton(AF_INET, argv[1], &address.sin_addr) != 1) {
        perror(RED"Error converting address"RESET);
        exit(EXIT_FAILURE);
    }

	// Connect to server
	if (connect(sockfd, (struct sockaddr*) &address, sizeof(struct sockaddr_in)) == -1) {
		perror(RED"Error connecting to server\n"RESET);
		exit(EXIT_FAILURE);
	}

	// Receive message from socket (size_t first and then the grid)
	size_t size_sqrt;
	size_t size;
	char* grid;
	if (recvfrom(sockfd, &size_sqrt, sizeof(size_t), 0, NULL, NULL) == -1) {
		perror(RED"Error receiving message size\n"RESET);
		exit(EXIT_FAILURE);
	}
	size = size_sqrt * size_sqrt;
	if ((grid = malloc(size)) == NULL) {
		perror(RED"Error allocating memory\n"RESET);
		exit(EXIT_FAILURE);
	}
	if (recvfrom(sockfd, grid, size, 0, NULL, NULL) == -1) {
		perror(RED"Error receiving message\n"RESET);
		exit(EXIT_FAILURE);
	}

	// Print response
	printf(YELLOW"Client: received grid of size %zu.\n"RESET, size);
	int i;
	for (i = 0; i < size; i++) {
		if (i % size_sqrt == 0)
			printf("\n");
		if (grid[i] == '0')
			printf("%c ", grid[i]);
		else
			printf(GREEN"%c "RESET, grid[i]);
	}
	printf("\n");

	// Close socket
    if (close(sockfd) == -1) {
        perror(RED"Error closing socket\n"RESET);
        exit(EXIT_FAILURE);
    }

	// Print message and exit
    printf(GREEN"Client: done.\n"RESET);
	return EXIT_SUCCESS;
}

